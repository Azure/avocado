trigger:
  - main

extends:
  template: /eng/1es-redirect.yml
  parameters:
    stages:
    - stage: Build_And_Test
      displayName: 'Build and Test'

      variables:
        - template: /eng/image.yml

      jobs:
      - job: Build
        pool:
          image: $(LINUXVMIMAGE)
          name: $(LINUXPOOL)
          os: linux
        steps:
          - task: NodeTool@0
            displayName: 'Install Node'
            inputs:
              versionSpec: 22.x

          - script: npm ci
            displayName: 'npm ci'

          - script: npm ls -a
            displayName: 'npm ls -a'
            condition: succeededOrFailed()
            continueOnError: true

          - task: Npm@1
            displayName: 'npm pack'
            inputs:
              command: custom
              verbose: false
              customCommand: pack

          - task: CopyFiles@2
            displayName: 'Copy Files to: drop'
            inputs:
              Contents: '*.tgz'
              TargetFolder: $(Build.ArtifactStagingDirectory)

          - template: /eng/publish-1es-artifact.yml
            parameters:
              artifactName: 'drop'
              artifactPath: '$(Build.ArtifactStagingDirectory)'

          - pwsh: |
              Write-Host "##vso[task.setvariable variable=PACKAGE_VERSION;isOutput=true]$(node -p "require('./package.json').version")"
            displayName: 'Set output variable PACKAGE_VERSION'
            name: 'setPackageVersion'

      - job: Test_Windows
        strategy:
          matrix:
            Win.Node20:
              node.version: 20.x
            Win.Node22:
              node.version: 22.x
        pool:
          image: $(WINDOWSVMIMAGE)
          name: $(WINDOWSPOOL)
          os: windows
        steps:
          - template: /eng/test-steps.yml
            parameters:
              version: $(node.version)

      - job: Test_Linux
        strategy:
          matrix:
            Linux.Node20:
              node.version: 20.x
            Linux.Node22:
              node.version: 22.x
        pool:
          image: $(LINUXVMIMAGE)
          name: $(LINUXPOOL)
          os: linux
        steps:
          - template: /eng/test-steps.yml
            parameters:
              version: $(node.version)

    # only include if running on `internal` build with manual queue, otherwise never include
    - ${{ if and(in(variables['Build.Reason'], 'Manual', ''), eq(variables['System.TeamProject'], 'internal'))}}:
      - stage: Publish
        displayName: Publish
        dependsOn: Build_And_Test
        variables:
          - name: PACKAGE_VERSION
            value: $[ stageDependencies.Build_And_Test.Build.outputs['setPackageVersion.PACKAGE_VERSION'] ]

        jobs:
          - deployment: Publish
            environment: 'package-publish'
            pool:
              name: azsdk-pool
              image: ubuntu-24.04
              os: linux

            strategy:
              runOnce:
                deploy:
                  steps:
                  - download: current
                    artifact: drop
                    timeoutInMinutes: 5

                  - pwsh: |
                      # get the pkgVersion from output variable of previous stage
                      $pkgVersion = "$(PACKAGE_VERSION)"
                      # Function to check if a version is non-GA
                      function Is-NonGA($version) {
                          return $version -match "-(alpha|beta|rc|pre)"
                      }

                      if (Is-NonGA($pkgVersion)) {
                          Write-Host "##vso[task.setvariable variable=Tag;]beta"
                      }
                      else {
                          Write-Host "##vso[task.setvariable variable=Tag;]latest"
                      }
                    displayName: 'Determine release tag'

                  - pwsh: |
                      Write-Host "Will deploy with tag of $(Tag)"
                      Get-ChildItem "$(Pipeline.Workspace)/drop" -Recurse -Force `
                        | Where-Object { $_.Name -like "*.tgz" } `
                        | Copy-Item -Destination "$(Build.ArtifactStagingDirectory)"

                      Get-ChildItem "$(Build.ArtifactStagingDirectory)" -Recurse -Force | % { Write-Host $_.FullName }
                    displayName: Move artifact to $(Build.ArtifactStagingDirectory)

                  - task: EsrpRelease@9
                    displayName: 'Publish oav to ESRP'
                    inputs:
                      ConnectedServiceName: 'Azure SDK PME Managed Identity'
                      ClientId: '5f81938c-2544-4f1f-9251-dd9de5b8a81b'
                      DomainTenantId: '975f013f-7f24-47e8-a7d3-abc4752bf346'
                      UseManagedIdentity: true
                      KeyVaultName: 'kv-azuresdk-codesign'
                      SignCertName: 'azure-sdk-esrp-release-certificate'
                      Intent: 'PackageDistribution'
                      ContentType: 'npm'
                      FolderLocation: $(Build.ArtifactStagingDirectory)
                      Owners: ${{ coalesce(variables['Build.RequestedForEmail'], 'azuresdk@microsoft.com') }}
                      Approvers: 'azuresdk@microsoft.com'
                      ServiceEndpointUrl: 'https://api.esrp.microsoft.com'
                      MainPublisher: 'ESRPRELPACMANTEST'
                      productstate: $(Tag)
